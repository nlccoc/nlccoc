/* global nlccmgmtapp, gon, Layout, $, I18n, QuickSidebar, moment, toastr */

var youtubeID = function(link){
  var video_id = link.split('v=')[1];
  var ampersandPosition = video_id.indexOf('&');
  if(ampersandPosition != -1) {
    video_id = video_id.substring(0, ampersandPosition);
  }
  return video_id;
}

nlccmgmtapp.controller('mgmtCtrl', ['$scope', '$rootScope', 'settings', function($scope, $rootScope, settings){
  console.log('Mgmt Controller');
  $rootScope.I18n = I18n
  I18n.defaultLocale = "zh";
  I18n.locale = "zh";
  //I18n.currentLocale();
  //console.log(gon.current_mgmt);
  $scope.current_mgmt = gon.current_mgmt;
  $scope.fullHeight = '700px';
  // set default layout mode
	$rootScope.settings.layout.pageContentWhite = true;
  $rootScope.settings.layout.pageBodySolid = false;
  $rootScope.settings.layout.pageSidebarClosed = false;
  console.log(I18n.t('event.category.equipping'));
}]);
nlccmgmtapp.controller('eventAllCtrl', ['$scope', 'categoryFactory', '$uibModal', function($scope, categoryFactory, $uibModal){
  console.log('Event Controller');
  
  categoryFactory.getAllCategories().then(function(data){
    $scope.categories = data;
    console.log(data);
  });
    
  $scope.getDate = function(d){
    return new Date(d).toString();
  }
  $scope.event = event;
  
  $scope.deleteEvent = function(event, category){
    console.log("DeleteEvent");
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl: 'mgmts/confirmModel.html',
      controller: 'modalDeleteEventCtrl',
      resolve: {
        event: function () {
          return event;
        }
      }
    });
    
    modalInstance.result.then(function (result) {
      console.log(result);
      if(result == 0) {
        console.log("result: " + result);
        var idx=0, idx1=0;
        for (idx1=0; idx1 < $scope.categories.length; idx1++){
          for(idx=0; idx < $scope.categories[idx1].events.length; idx++){
            if (event.id == $scope.categories[idx1].events[idx].id){
              $scope.categories[idx1].events.splice(idx, 1);
            }
          }
        }
        toastr.success('Remove event \'' + event.title + '\' successfully');
        return
      }
    });
  }
  
}]).controller('eventNewCtrl', ['$scope', 'categories', 'eventFactory', '$state', '$sce', 'locations',
function($scope, categories, eventFactory, $state, $sce, locations){
  console.log('Event New Controller');
  $scope.function='new';
  
  $scope.locations = locations;
  var d = new Date();
  d.setHours(9);
  d.setMinutes(0);
  $scope.event = {}
  $scope.event.period = {
    min: 50
  }
  //$('#period-slider').ionRangeSlider();
  /*$scope.event.datetime = '';
  $scope.$watch('event.datetime', function(newValue, oldValue) {
    console.log('Datetime changed.');
  });*/
  $scope.event.datetime = moment(d).format('MM/DD/YYYY h:mm a');
  $scope.event.title = '';
  $scope.event.short_desc= '';
  $scope.event.desc = '';
  $scope.event.location = '';
  //$scope.$apply($scope.event.datetime);
  
  $scope.meta={};
  $scope.meta.categories = categories
  
  //$('.date-picker').datetimepicker();
  $scope.repeat={};
  $scope.repeat.valid_until = moment(d).format('MM/DD/YYYY');
  $scope.repeat.isSelected = false;
  $scope.repeat.onText = 'Yes';
  $scope.repeat.offText = 'No';
  $scope.repeat.isActive = true;
  $scope.repeat.size = 'normal';
  $scope.repeat.animate = true;
  $scope.repeat.radioOff = true;
  $scope.repeat.handleWidth = "auto";
  $scope.repeat.labelWidth = "auto";
  $scope.repeat.inverse = true;
  $scope.repeat.onColor="success"
  $scope.repeat.offColor="danger"
  
  $scope.event.featured={};
  $scope.event.featured.valid_until = moment(d).format('MM/DD/YYYY');
  $scope.event.featured.isSelected = false;
  $scope.event.featured.onText = 'Yes';
  $scope.event.featured.offText = 'No';
  $scope.event.featured.isActive = true;
  $scope.event.featured.size = 'normal';
  $scope.event.featured.animate = true;
  $scope.event.featured.radioOff = true;
  $scope.event.featured.handleWidth = "auto";
  $scope.event.featured.labelWidth = "auto";
  $scope.event.featured.inverse = true;
  $scope.event.featured.onColor="success";
  $scope.event.featured.offColor="danger";
  
  $scope.meta.categories = categories;

  $scope.$watch('repeat.isSelected', function() {
    console.log('Selection changed.');
  });
  
  $scope.imageUpload = function(files) {
    console.log('image upload:', files);
    console.log('image upload\'s editable:', $scope.editable);
    console.log('image upload\'s editor', $scope.editor);
  }

  $scope.toggle = function() {
    $scope.isSelected = $scope.isSelected === true ? false : true;
  };

  $scope.setUndefined = function() {
    $scope.isSelected = undefined;
  };

  $scope.toggleActivation = function() {
    $scope.isActive = !$scope.isActive;
  }
  
  $scope.submit = function(func){
    //if ($scope.event.desc.length > 1024) {
    //  toastr.warning('Too long for the description: length: ' + $scope.event.desc.length + ', please revise it under 1024 characters');
    //  return;
    //}
    console.log(func);
    console.log("Submit");
    $scope.event.repeat = $scope.repeat;
    if(func == 'new'){
      eventFactory.createEvent($scope.event).then(function(data){
        //$scope.mvideos.push(data);
        //$scope.hideform();
        //console.log(data);
        toastr.success('Create event \'' + $scope.event.title + '\' successfully');
        $state.go('events-all');
      }).catch(function(data, status) {
        toastr.warning('Create event failed');
      });
    } else if(func == 'edit'){
      
    }
  }
}]).controller('eventEditCtrl', ['$scope', 'event', 'categories', 'eventFactory', '$state',
function($scope, event, categories, eventFactory, $state){
  console.log('Event Edit Controller');
  console.log(event)
  $scope.function = 'edit'
  $scope.meta={};
  $scope.meta.categories = categories;
  $scope.getDatetime = function(d){
    return new Date(d).toString();
  }
  $scope.event = event
  $scope.event.datetime = moment(event.datetime).format('MM/DD/YYYY h:mm a');
  $scope.event.desc = unescape($scope.event.desc)
  //console.log(unescape($scope.event.desc));
  //console.log(event);
  var cat = [];
  $scope.event.period = {
    min: event.event_period
  }
  
  $scope.event.categories.forEach(function(item, index){
    //console.log('push: ' + item.id);
    cat.push(item.id);
  })
  $scope.event.categories = cat;
  $scope.event.featured = {}
  $scope.repeat={};
  if($scope.event.repeat_metum.length==0){
    $scope.repeat.isSelected = false;
  }else{
    $scope.repeat.isSelected = true;
    
    $scope.repeat.valid_until =  moment.parseZone(event.repeat_metum[0].valid_until).format('L');
  }
  
  $scope.repeat.onText = 'Yes';
  $scope.repeat.offText = 'No';
  $scope.repeat.isActive = true;
  $scope.repeat.size = 'normal';
  $scope.repeat.animate = true;
  $scope.repeat.radioOff = true;
  $scope.repeat.handleWidth = "auto";
  $scope.repeat.labelWidth = "auto";
  $scope.repeat.inverse = true;
  $scope.repeat.onColor="success"
  $scope.repeat.offColor="danger"
  
  if ($scope.event.featured_info.length==0){
    $scope.event.featured.isSelected=false;
  } else {
    $scope.event.featured.isSelected=true;
    $scope.event.featured.title = $scope.event.featured_info.title;
    $scope.event.featured.subtitle = $scope.event.featured_info.subtitle;
    $scope.event.featured.image_path = $scope.event.featured_info.image_path;
  }
  
  $scope.meta.categories = categories;
  
  $scope.$watch('isSelected', function() {
    //console.log('Selection changed.');
  });

  $scope.imageUpload = function(files) {
    //console.log('image upload:', files);
   //console.log('image upload\'s editable:', $scope.editable);
    //console.log('image upload\'s editor', $scope.editor);
  }

  $scope.toggleActivation = function() {
    $scope.isActive = !$scope.isActive;
  }
  
  $scope.submit = function(func){
    console.log(func);
    $scope.event.repeat = $scope.repeat;
    if(func == 'new'){
      
    } else if(func == 'edit'){
      eventFactory.updateEvent($scope.event).then(function(data){
        //$scope.mvideos.push(data);
        //$scope.hideform();
        //console.log(data);
        toastr.success('Create event \'' + $scope.event.title + '\' successfully');
        $state.go('events-all');
      }).catch(function(data, status){
        toastr.warning('Create event failed');
      });
    }
  }
}]).controller('eventCtrl', ['$scope', 'event',
function($scope, event){
  $scope.event = event;
  $scope.event.desc = unescape(event.desc)
}])

/* Setup Layout Part - Header */
nlccmgmtapp.controller('headerController', ['$scope', function($scope) {
  console.log("Header Controller")
  $scope.$on('$includeContentLoaded', function() {
    Layout.initHeader(); // init header
  });
}]);
nlccmgmtapp.controller('sidebarController', ['$scope', function($scope) {
  console.log("Siderbar Controller");
  $scope.$on('$includeContentLoaded', function() {
    Layout.initSidebar();
  });
}]);

nlccmgmtapp.controller('quicksidebarController', ['$scope', function($scope) {
  console.log("quicksidebarController Controller");
  $scope.$on('$includeContentLoaded', function() {
    setTimeout(function(){
      QuickSidebar.init(); // init quick sidebar        
    }, 2000)
  });
}]);

nlccmgmtapp.controller('mediaVideoCtrl', ['$scope', '$timeout', 'mvideoFactory', '$uibModal', 'locations',
function($scope, $timeout, mvideoFactory, $uibModal, locations) {
  console.log("mediaVideoCtrl Controller");
  $scope.locations=locations;
  $scope.animationsEnabled = true;
  $scope.newvideo={};
  $scope.newvideo.title='';
  $scope.newvideo.date='';
  $scope.newvideo.path='';
  $scope.newvideo.desc='';
  $scope.newvideo.locat=$scope.locations[0];
  $scope.getMonth = function(date) {
    var monthNames = [
      "Jan", "Feb", "Mar",
      "Apr", "May", "Jun", "Jul",
      "Aug", "Sep", "Oct",
      "Nov", "Dec"
    ];
    var d = new Date(date);
    //console.log('get month');
    return monthNames[d.getMonth()]
  }
  
  $scope.getDay = function(date) {
    var d = new Date(date);
    //console.log(date);
    return d.getDate()+1;
  }
  
  $scope.createMVideo = function(mvideo){
    //console.log(mvideo);
    mvideo.youtubeID = youtubeID(mvideo.path);
    mvideoFactory.createMVideo(mvideo).then(function(data){
      $scope.mvideos.push(data);
      $scope.hideform();
      console.log("Success create a Media");
    });
  }
  
  $scope.deleteMVideo = function(mvideo){
    console.log("DeleteMVideo");
    var modalInstance = $uibModal.open({
      animation: $scope.animationsEnabled,
      templateUrl: 'myModalContent.html',
      controller: 'modalDeleteMvideoCtrl',
      resolve: {
        mvideo: function () {
          return mvideo;
        }
      }
    });
    
    modalInstance.result.then(function (result) {
      //console.log(result);
      if(result == 0) {
        var idx = 0;
        for(idx=0; idx<$scope.mvideos.length; idx++){
          if (mvideo.id == $scope.mvideos[idx].id){
            $scope.mvideos.splice(idx, 1);
            return;
          }
        }
      }
    });
  
  }
  
  $scope.showform = function() {
    $('#newEventForm').slideDown(400);
  }
  
  $scope.hideform = function() {
    $('#newEventForm').slideUp(400);
  }
  
  $scope.$on('$viewContentLoaded', function() {
    console.log("view content loaded");
    mvideoFactory.getAllMvideos().then(function(data){
      $scope.mvideos = data;
      //console.log(data);
    });
    $timeout(function(){
     }, 0)
  });
}]);

nlccmgmtapp.controller('mediaAudioCtrl', ['$scope', '$timeout', 'maudios', '$uibModal',
function($scope, $timeout, maudios, $uibModal) {
  console.log("mediaAudioCtrl Controller");
  $scope.maudios = maudios;
  
  $scope.deleteMaudio = function(maudio){
    console.log("DeleteMaudio");
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl: 'mgmts/confirmModel.html',
      controller: 'modalDeleteMaudioCtrl',
      resolve: {
        maudio: function () {
          return maudio;
        }
      }
    });
    
    modalInstance.result.then(function (result) {
      //console.log(result);
      if(result == 0) {
        //console.log("result: " + result);
        var idx=0;
        for (idx=0; idx < $scope.maudios.length; idx++){
          if (maudio.id == $scope.maudios[idx].id){
            $scope.maudios.splice(idx, 1);
          }
        }
        toastr.success('Remove maudio \'' + maudio.title + '\' successfully');
        return
      }
    });
  }
  
}]);
nlccmgmtapp.controller('audioNewCtrl', ['$scope', 'maudioFactory', '$state', function($scope, maudioFactory, $state){
  $scope.function = 'new';
  $scope.maudio = {};
  $scope.maudio.title='';
  $scope.maudio.desc='';
  $scope.maudio.date='';
  $scope.maudio.path='';
  $scope.maudio.speaker='陳振榮牧師';
  
  $scope.maudio.featured={};
  $scope.maudio.featured.isSelected=false;
  $scope.maudio.featured.onText = 'Yes';
  $scope.maudio.featured.offText = 'No';
  $scope.maudio.featured.isActive = true;
  $scope.maudio.featured.size = 'normal';
  $scope.maudio.featured.animate = true;
  $scope.maudio.featured.radioOff = true;
  $scope.maudio.featured.handleWidth = "auto";
  $scope.maudio.featured.labelWidth = "auto";
  $scope.maudio.featured.inverse = true;
  $scope.maudio.featured.onColor="success"
  $scope.maudio.featured.offColor="danger"
  
  
  $scope.submit = function(func){
    if(func=='new'){
      maudioFactory.createMaudio($scope.maudio).then(function(data){
        console.log("Success create a maudio");
        $state.go('media-audio');
        toastr.success('Success create audio' + $scope.title);
      });
    }
  }
}]);

nlccmgmtapp.controller('mediaAudioEditCtrl', ['$scope', '$timeout', 'maudio', 'maudioFactory', '$state',
function($scope, $timeout, maudio, maudioFactory, $state) {
  console.log("mediaAudioCtrl Controller");
  $scope.maudio = maudio;
  $scope.function = 'edit';

  /* same naming work around*/
  $scope.maudio.tfeature = maudio.featured;
  
  $scope.maudio.featured={};
  $scope.maudio.featured.isSelected=$scope.maudio.tfeature;
  $scope.maudio.featured.onText = 'Yes';
  $scope.maudio.featured.offText = 'No';
  $scope.maudio.featured.isActive = true;
  $scope.maudio.featured.size = 'normal';
  $scope.maudio.featured.animate = true;
  $scope.maudio.featured.radioOff = true;
  $scope.maudio.featured.handleWidth = "auto";
  $scope.maudio.featured.labelWidth = "auto";
  $scope.maudio.featured.inverse = true;
  $scope.maudio.featured.onColor="success";
  $scope.maudio.featured.offColor="danger";
  
  
  $scope.submit = function(func){
    if(func=='edit'){
      maudioFactory.updateMaudio($scope.maudio).then(function(data){
        $state.go('media-audio');
        console.log("Success updated a maudio");
        toastr.success('Success updated audio' + $scope.maudio3.title);
      });
    }
  }
}]);

nlccmgmtapp.controller('libraryCtrl', ['$scope', 'libraries', '$uibModal', function($scope, libraries, $uibModal){
  console.log('library Controller');
  $scope.libraries = libraries;
  
  $scope.deleteLibrary = function(library){
    console.log("DeleteLibrary");
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl: 'mgmts/confirmModel.html',
      controller: 'modalDeleteLibraryCtrl',
      resolve: {
        library: function () {
          return library;
        }
      }
    });
    
    modalInstance.result.then(function (result) {
      //console.log(result);
      if(result == 0) {
        console.log("result: " + result);
        var idx=0;
        for (idx=0; idx < $scope.libraries.length; idx++){
          if (library.id == $scope.libraries[idx].id){
            $scope.libraries.splice(idx, 1);
          }
        }
        toastr.success('Remove library \'' + library.name + '\' successfully');
        return
      }
    });
  }
}]);

nlccmgmtapp.controller('modalDeleteMvideoCtrl', ['$scope', '$uibModalInstance', 'mvideoFactory', 'mvideo', 
function ($scope, $uibModalInstance, mvideoFactory, mvideo) {

  $scope.ok = function () {
    //console.log("delete {" + mvideo.id + "}");
    mvideoFactory.deleteMVideo(mvideo.id).then(function(data){
      console.log("Successfully delete the m-video");
    });
    $uibModalInstance.close(0);
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
}]);
nlccmgmtapp.controller('modalDeleteEventCtrl', ['$scope', '$uibModalInstance', 'eventFactory', 'event', 
function ($scope, $uibModalInstance, eventFactory, event) {

  $scope.ok = function () {
    //console.log("delete {" + event.id + "}");
    //console.log(event);
    eventFactory.deleteEvent(event.id).then(function(data){
      console.log("Successfully delete the m-video");
    });
    $uibModalInstance.close(0);
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
}]);
nlccmgmtapp.controller('modalDeleteLibraryCtrl', ['$scope', '$uibModalInstance', 'libraryFactory', 'library', 
function ($scope, $uibModalInstance, libraryFactory, library) {

  $scope.ok = function () {
    //console.log("delete {" + library.id + "}");
    //console.log(library);
    libraryFactory.deleteLibrary(library.id).then(function(data){
      console.log("Successfully delete the library");
    });
    $uibModalInstance.close(0);
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
}]);
nlccmgmtapp.controller('modalDeleteMaudioCtrl',['$scope', '$uibModalInstance', 'maudioFactory', 'maudio', 
function ($scope, $uibModalInstance, maudioFactory, maudio) {
  $scope.ok = function () {
    //console.log("delete {" + maudio.id + "}");
    //console.log(maudio);
    maudioFactory.deleteMaudio(maudio.id).then(function(data){
      console.log("Successfully delete the maudio");
    });
    $uibModalInstance.close(0);
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
}])
nlccmgmtapp.controller('FileUploadCtrl', ['$scope', 'FileUploader', '$state', '$timeout', function($scope, FileUploader, $state, $timeout){
  $scope.library={};
  $scope.library.name='';
  var uploader = $scope.uploader = new FileUploader(
  {
    headers : {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    },
    url: '/libraries',
    alias: 'library[attachment]'
  });
  // FILTERS
  uploader.filters.push(
  {
      name: 'customFilter',
      fn: function(item /*{File|FileLikeObject}*/ , options)
      {
          return this.queue.length < 10;
      }
  });
  // CALLBACKS
  uploader.onWhenAddingFileFailed = function(item /*{File|FileLikeObject}*/ , filter, options)
  {
      console.info('onWhenAddingFileFailed', item, filter, options);
  };
  uploader.onAfterAddingFile = function(fileItem)
  {
    //console.log($scope.library.name);
    console.info('onAfterAddingFile', fileItem);
  };
  uploader.onAfterAddingAll = function(addedFileItems)
  {
      console.info('onAfterAddingAll', addedFileItems);
  };
  uploader.onBeforeUploadItem = function(item)
  {
    item.formData.push({"library[name]": $scope.library.name});
    console.info('onBeforeUploadItem', item);
  };
  uploader.onProgressItem = function(fileItem, progress)
  {
      console.info('onProgressItem', fileItem, progress);
  };
  uploader.onProgressAll = function(progress)
  {
    console.info('onProgressAll', progress);
  };
  uploader.onSuccessItem = function(fileItem, response, status, headers)
  {
      console.info('onSuccessItem', fileItem, response, status, headers);
  };
  uploader.onErrorItem = function(fileItem, response, status, headers)
  {
      console.info('onErrorItem', fileItem, response, status, headers);
  };
  uploader.onCancelItem = function(fileItem, response, status, headers)
  {
      console.info('onCancelItem', fileItem, response, status, headers);
  };
  uploader.onCompleteItem = function(fileItem, response, status, headers)
  {
      console.info('onCompleteItem', fileItem, response, status, headers);
  };
  uploader.onCompleteAll = function()
  {
      console.info('onCompleteAll');
      $timeout(function(){
      $state.go('media-library');
    }, 500)
  };
  console.info('uploader', uploader);
}]);

